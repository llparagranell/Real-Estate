// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model Broker {
  id        String  @id @default(cuid())
  firstName String
  lastName  String
  email     String  @unique
  phone     String  @unique
  whatsapp  String?
  password  String
  avatar    String?
  isBlocked Boolean @default(false)

  //verification
  isEmailVerified Boolean @default(false)
  isPhoneVerified Boolean @default(false)

  //upload tracking
  freeUploadsUsed Int @default(0)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  properies     Property[]
  subscriptions Subscriptions?
  otp           Otp[]
  refreshToken  RefreshToken[]

  @@map("brokers")
}

//property
enum PropertyType {
  FARMLAND
  DUPLEX
  FLAT
  PLOT
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  SOLD
  DRAFT
}

enum SizeUnit {
  ACRES
  UNITS
  SQFT
  SQMT
}

model Property {
  id           String         @id @default(cuid())
  title        String
  description  String?
  propertyType PropertyType
  status       PropertyStatus
  priceMin     Float
  priceMax     Float? //for price range
  isNegotiable Boolean //?
  state        String
  city         String
  area         String
  address      String
  latitude     String
  longitude    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  //Relations
  brokerId String
  broker   Broker          @relation(fields: [brokerId], references: [id], onDelete: Cascade)
  media    PropertyMedia[]

  @@index([brokerId])
  @@index([propertyType])
  @@index([status])
  @@index([state, city])
  @@index([priceMin])
  @@map("properties")
}

// property media

enum MediaType {
  IMAGE
  VIDEO
}

model PropertyMedia {
  id        String   @id @default(cuid())
  url       String
  key       String // s3 key for deletion
  mediaType String
  order     Int      @default(0) // for ordering photos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("property_media")
}

enum PlanType {
  FREE
  PREMIUM
}

model Plan {
  id                String          @id @default(cuid())
  name              String
  type              PlanType        @unique
  price             Float
  maxUploads        Int? //null = unlimited
  featuredListing   Boolean         @default(false)
  priorityVisibilty Boolean         @default(false)
  validityDays      Int // 0 for free plan
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  subscriptions     Subscriptions[]

  @@map("plans")
}

model Subscriptions {
  id        String    @id @default(cuid())
  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  brokerId String    @unique
  broker   Broker    @relation(fields: [brokerId], references: [id], onDelete: Cascade)
  planId   String    @unique
  plan     Plan      @relation(fields: [planId], references: [id])
  payments Payment[]

  @@map("subscriptions")
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentMethods {
  UPI
  CARD
  NETBANKING
}

model Payment {
  id               String          @id @default(cuid())
  amount           Float
  currency         String          @default("INR")
  status           PaymentStatus   @default(PENDING)
  method           PaymentMethods?
  gatewayOrderId   String?
  gatewayPaymentId String
  gatewaySignature String

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  subscriptionId String
  subscripton    Subscriptions @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("payments")
}

//AUTH

enum OtpType {
  EMAIL
  PHONE
}

model Otp {
  id        String   @id @default(cuid())
  code      String
  type      OtpType
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())
  brokerId  String
  broker    Broker   @relation(fields: [brokerId], references: [id], onDelete: Cascade)

  @@index([brokerId, code])
  @@map("otps")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())
  brokerId  String
  broker    Broker   @relation(fields: [brokerId], references: [id], onDelete: Cascade)

  @@index([brokerId])
  @@map("refresh_tokens")
}
